<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Playlist</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background-color: #96BC33;
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    #container {
      background-color: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      text-align: center;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 20px;
    }

    .grid-container {
      display: grid;
      grid-gap: 10px;
      justify-items: center;
      align-items: center;
    }

    .grid-item {
      position: relative;
      overflow: hidden;
      width: 200px;
      height: 260px;
      border-radius: 10px;
      transition: filter 0.3s ease;
    }

    .grid-item iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .grid-item .track-name {
      color: #fff;
      font-family: 'Barlow', 'Open Sans', 'Lucida Grande', 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif;
      font-size: 18px;
      font-weight: 600;
      line-height: 18px;
      margin: 10px 0;
      text-align: center;
      text-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
    }

    button {
      background-color: #96BC33;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      margin-bottom: 10px;
      align-self: center;
    }

    button:hover {
      background-color: #4caf50;
    }
  </style>
</head>
<body>
  <div id="container">
    <h1>Playlist</h1>
    <div class="grid-container" id="playlist-grid"></div>
  </div>

  <script>
function getUserId(accessToken) {
  const url = 'https://api.spotify.com/v1/me';
  const headers = {
    'Authorization': 'Bearer ' + accessToken
  };

  return fetch(url, {
    headers: headers
  })
    .then(response => {
      if (response.ok) {
        return response.json();
      } else {
        window.location.href = 'callback.html';
        throw new Error('Failed to get user ID');
      }
    })
    .then(data => data.id);
}

function createPlaylist(userId) {
  const url = `https://api.spotify.com/v1/users/${userId}/playlists`;
  const headers = {
    'Authorization': 'Bearer ' + getAccessToken(),
    'Content-Type': 'application/json'
  };

  const playlistName = 'Playlist personalizada para ' + username;
  const playlistDescription = 'Playlist creada segun las preferencias musicales de ' + username;

  const data = {
    name: playlistName,
    description: playlistDescription,
    public: false
  };

  return fetch(url, {
    method: 'POST',
    headers: headers,
    body: JSON.stringify(data)
  })
    .then(response => {
      if (response.ok) {
        return response.json();
      } else {
        throw new Error('Failed to create playlist');
      }
    })
    .then(data => {
      console.log('Playlist created');
      return data.id;
    });
}

function addTracksToPlaylist(playlistId, tracks) {
  const url = `https://api.spotify.com/v1/playlists/${playlistId}/tracks`;
  const headers = {
    'Authorization': 'Bearer ' + getAccessToken(),
    'Content-Type': 'application/json'
  };

  const data = {
    uris: tracks
  };

  return fetch(url, {
    method: 'POST',
    headers: headers,
    body: JSON.stringify(data)
  })
    .then(response => {
      if (response.ok) {
        return response.json();
      } else {
        throw new Error('Failed to add tracks to playlist');
      }
    });
}

function showPlaylist(playlistId) {
  const playlistsContainer = document.getElementById('playlists');

  const playlistElement = document.createElement('div');
  playlistElement.className = 'playlist-item';

  const iframeElement = document.createElement('iframe');
  iframeElement.src = `https://open.spotify.com/embed/playlist/${playlistId}`;
  iframeElement.width = '300';
  iframeElement.height = '380';
  iframeElement.frameborder = '0';
  iframeElement.allowtransparency = 'true';
  iframeElement.allow = 'encrypted-media';

  playlistElement.appendChild(iframeElement);
  playlistsContainer.appendChild(playlistElement);
}

function getAccessToken() {
  const accessToken = localStorage.getItem('spotify_access_token');
  if (!accessToken) {
    window.location.href = 'callback.html';
    throw new Error('Access token not found');
  }
  return accessToken;
}

// Get the tracks from the URL query parameters
const urlParams = new URLSearchParams(window.location.search);
const tracksParam = urlParams.get('tracks');
const tracks = JSON.parse(decodeURIComponent(tracksParam));

// Get the access token
const accessToken = getAccessToken();

// Get the user ID
getUserId(accessToken)
  .then(userId => {
    // Create a playlist
    return createPlaylist(userId);
  })
  .then(playlistId => {
    // Add the tracks to the playlist
    return addTracksToPlaylist(playlistId, tracks);
  })
  .then(() => {
    // Show the playlist
    showPlaylist(playlistId);
  })
  .catch(error => {
    console.error('Error:', error);
  });

  </script>
</body>
</html>
